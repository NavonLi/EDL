name: Update Threat Intelligence EDL

on:
  schedule:
    # æ¯å¤© UTC 00:00 åŸ·è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-edl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Create necessary directories
      run: |
        mkdir -p edl stats scripts
        
    - name: Fetch and merge threat intelligence
      run: python scripts/update_edl.py
      continue-on-error: false
      
    - name: List generated files
      run: |
        echo "=== EDL ç›®éŒ„å…§å®¹ ==="
        ls -lh edl/ || echo "EDL ç›®éŒ„ä¸å­˜åœ¨"
        echo ""
        echo "=== Stats ç›®éŒ„å…§å®¹ ==="
        ls -lh stats/ || echo "Stats ç›®éŒ„ä¸å­˜åœ¨"
        
    - name: Show file previews
      run: |
        echo "=== malicious_ips_v4.txt å‰ 10 è¡Œ ==="
        head -20 edl/malicious_ips_v4.txt || echo "æª”æ¡ˆä¸å­˜åœ¨"
        echo ""
        echo "=== malicious_domains.txt å‰ 10 è¡Œ ==="
        head -20 edl/malicious_domains.txt || echo "æª”æ¡ˆä¸å­˜åœ¨"
        
    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
    - name: Check and commit changes
      id: commit
      run: |
        # å°‡æ–°æª”æ¡ˆåŠ å…¥ Git
        git add edl/ stats/
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ç™¼ç¾è®Šæ›´ï¼Œæº–å‚™æäº¤"
          git status
          git commit -m "Auto-update EDL lists - $(date +'%Y-%m-%d %H:%M:%S UTC')" || echo "æäº¤å¤±æ•—"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Push changes
      if: steps.commit.outputs.has_changes == 'true'
      run: |
        git push origin main || git push origin master
        echo "âœ… è®Šæ›´å·²æŽ¨é€åˆ° repository"
        
    - name: Deploy to GitHub Pages
      if: steps.commit.outputs.has_changes == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./edl
        publish_branch: gh-pages
        
    - name: Summary
      if: always()
      run: |
        echo "## ðŸ“Š EDL æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "stats/latest.json" ]; then
          echo "### çµ±è¨ˆè³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat stats/latest.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç”¢ç”Ÿçš„æª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -lh edl/ 2>/dev/null || echo "ç„¡æ³•åˆ—å‡ºæª”æ¡ˆ"
        echo '```' >> $GITHUB_STEP_SUMMARY
